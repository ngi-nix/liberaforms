
# Install GNGforms

## Install mongodb
apt-get install mongodb

## Clone gngforms and create config.cfg

git clone https://gitlab.com/lleialtec/gngforms.git /opt/GNGforms
cd /opt/GNGforms
cp config.example.cfg config.cfg

And edit /opt/GNGforms/config.cfg

You can create a SECRET_KEY like this

openssl rand -base64 32


## Create a python3 venv

If you have Python3 on your host

apt-get install python3-venv
python3 -m venv /opt/GNGforms/venv

Or if you have old python2 on your host

apt-get install virtualenv
virtualenv /opt/GNGforms/venv --python=python3


## Install python packages

source /opt/GNGforms/venv/bin/activate
pip install --upgrade setuptools
pip install wheel
pip install -r /opt/GNGforms/requirements.txt
pip install gunicorn

### File permissions
You need to give the user who will run gngforms write permission

chown -R www-data /opt/GNGforms


### Test your installation
source /opt/GNGforms/venv/bin/activate
gunicorn -c /opt/GNGforms/gunicorn.py gngforms:app


## Install Supervisor to keep GNGforms running
apt-get install supervisor

Edit /etc/supervisor/conf.d/GNGforms.conf

[program:GNGforms]
command = /opt/GNGforms/venv/bin/gunicorn -c /opt/GNGforms/gunicorn.py gngforms:app
directory = /opt/GNGforms
user = www-data


### Restart supervisor and check if GNGforms is running

systemctl restart supervisor
supervisorctl status GNGforms


## Debug GNGforms

supervisorctl stop GNGforms
cd /opt/GNGforms
source /opt/GNGforms/venv/bin/activate
python run


# Configure nginx proxy

## edit /etc/hosts and add an entry to point to your gunicorn process ip

127.0.0.1	gngforms


## edit a new nginx hosts file

server {
    listen         80;
    server_name    my_domain.com;
    return         301 https://$server_name$request_uri;
}
server {
    listen 443 ssl;    
    server_name my_domain.com;

    ssl_certificate           /etc/letsencrypt/live/my_domain.com/fullchain.pem;
    ssl_certificate_key       /etc/letsencrypt/live/my_domain.com/privkey.pem;
    ssl_dhparam               /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass          http://gngforms:5000;
        proxy_set_header    Host    $host;
        proxy_set_header    X-Forwarded-For $remote_addr;
        proxy_set_header    X-Real-IP   $remote_addr;
        proxy_pass_header   server;        
    }
    access_log /var/log/nginx/gngforms.access.log;
    error_log /var/log/nginx/gngforms.error.log notice;
}
