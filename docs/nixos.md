# WIP LiberaForms nixos-container installation

This is the install process currently being used for the development of a flake for LiberaForms. 
The final process will change to be more suited for a production NixOS system rather than development work.

## Clone LiberaForms flake repo from ngi-nix

```
git clone -b flake https://github.com/ngi-nix/liberaforms.git
```

## Install nix with flakes

Add the following to your NixOS configuration to install the nixUnstable version of the nix package manager, with the experimental feature for flakes enabled:
```
nix = {
  package = pkgs.nixUnstable;
  extraOptions = ''
    experimental-features = nix-command flakes
  '';
};
```
And then run `nixos-rebuild switch` to enable the new configuration.
Taken from https://nixos.wiki/wiki/Flakes#System-wide_installation

## Nix flake

The `flake.nix` (along with the nix/module.nix) contains the configuration to start a nixos-container running LiberaForms and all of its dependencies and recommended configurations (postgres, nginx, and db backups). One additional line can also enable HTTPS through nginx, but this is not enabled by default. With a few exceptions, most of the required secrets and variables are generated by default.   

### Edit the flake.nix

Currently `rootEmail` is the only variable that must be edited before running the flake for LiberaForms. It will be used as a the ROOT_USERS variable in the .env config file, and also as the contact email for a cert on letsencrypt if HTTPS is enabled. 

## NixOS container

### Create and start

Within the cloned `liberaforms` directory, run the following commands to create and then start the nixos-container
```
sudo nixos-container create liberaforms --flake ./#liberaforms
sudo nixos-container start liberaforms
```
The `create` command will output a local container IP address (such as 10.233.1.2). Once the container is started, visiting this address in a browser on the host system will display the LiberaForms instance. Note that this initial visit will trigger the initalization of the LiberaForms app. This means that LiberaForms' hostname for itself will depend on the URL that is used to access it for the first time. 

### Login

This command can be used to login to a root shell for the container:
```
sudo nixos-container root-login liberaforms
```

### Update

If you make changes to the flake.nix or the nix/module.nix and would like to see them reflected in an already running container, you can use the update command for this purpose:
```
sudo nixos-container update liberaforms --flake ./liberaforms
```

### Stop and destroy

A container that has been started can be stopped, and one that has been created can be destroyed:
```
sudo nixos-container stop liberaforms
sudo nixos-container destroy liberaforms
```





