{% extends "base.html" %}
{% block content %}

<script src="/static/dataTables/jquery.dataTables.min.js"></script>
<script src="/static/dataTables/dataTables.bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/dataTables/dataTables.bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">

<style>
.table td:first-child {
    text-align: center;
}â€‹
</style>

<div class="container">
    <div class="row col-md-9" style="font-size:1.5em">
    <input class="btn-primary btn btn-sm" type="button" value="{%trans%}Form details{%endtrans%}" onClick="location.href='/forms/view/{{ form._id }}'">
    {{ form.slug }}
    </div>
    
    <div class="row col-md-3" style="text-align:right">
    <input class="btn-primary btn btn-sm" type="button" value="{%trans%}Download CSV{%endtrans%}" onClick="location.href='/forms/csv/{{ form._id }}'">
    <input class="btn-danger btn btn-sm" type="button" value="{%trans%}Delete all entries{%endtrans%}" onClick="location.href='/forms/delete-entries/{{ form._id }}'" {% if not form.totalEntries %}disabled{%endif%} >
    </div>
</div>

<div class="container">
    <hr style="margin-bottom:5px" />
    
    {% if form.editors[g.current_user._id|string] is defined %}
        <div id="toggle_notification" class="btn-group btn-toggle">
            <button id="notification_true" class="btn btn-xs btn-default {% if form.data.editors[g.current_user._id|string]['notification']['newEntry'] %}btn-success{% endif %}">{%trans%}True{%endtrans%}</button>
            <button id="notification_false" class="btn btn-xs btn-default {% if not form.data.editors[g.current_user._id|string]['notification']['newEntry'] %}btn-primary{% endif %}">{%trans%}False{%endtrans%}</button>
        </div>
        {%trans%}Notify me on each new entry{%endtrans%}
    {% endif %}
    
    <p>&nbsp;</p>

    <table id="formEntries" class="table table-striped table-condensed">
    <thead>
        <tr>
        <th></th>
        {% for field in fieldIndex %}
            <th>{{ field['label'] }}</th>
        {% endfor %}
        </tr>
    </thead>

    {% for entry in form.entries %}
    <tr>
        <td id="row_{{ loop.index }}" style="border-right: 1px solid #ccc;">
            <i class="fa fa-ban delete-row" aria-hidden="true"></i>
        </td>
        {% for field in fieldIndex  %}
            <!-- Keep this TD on one line! -->
            <td class="{{ fieldName }}" style="border-right: 1px solid #ccc;">{{ entry[field['name']] }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
    </table>
</div>


{% if form.editors[g.current_user._id|string] is defined %}
<script>
var csrftoken = "{{ csrf_token() }}";
var deletedEntries={};
$(document).ready(function() {
    $('#formEntries').DataTable({
        "language": {
            "url": "/static/dataTables-languages/{{g.current_user.language}}.js"
        },
        "order": [[1, 'asc']],
        "columnDefs": [
            { "orderable": false, "targets": 0 }
        ]
    });
    
    $('#formEntries tbody').on('click', '.delete-row', function () {
        var $row=$(this).parents('tr');
        var $row_number=$(this).parent('td').attr('id');
        var rowData = new Array();
        $row.find('td:not(:first-child)').each (function() {
            rowData.push($(this).html())
        });
        //console.log(rowData);
        $.ajax({
            url : "/forms/delete-entry/{{ form._id }}",
            type: "POST",
            dataType: "json",
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify(rowData),
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                }
            },
            success: function(data, textStatus, jqXHR)
            {
                if (data.deleted == true) {
                    deletedEntries[$row_number] = rowData;
                    //console.log(deletedEntries);
                    $row.children(':not(:first-child)').addClass('deleted-row');
                    $row.children(':not(:first-child)').html('');
                    $row.children('td').eq(1).html("{%trans%}Deleted{%endtrans%}");
                    $row.children('td').eq(0).html('<i class="fa fa-undo undo-delete-row" aria-hidden="true"></i>');
                }
            }
        });
    });
    
    $('#formEntries tbody').on('click', '.undo-delete-row', function () {
        var $row_number=$(this).parent('td').attr('id');
        console.log($(this).parents('td').attr('id'));
        
        if (!($row_number in deletedEntries)) {
            return;
        }
        var rowData = deletedEntries[$row_number]
        var $row = $(this).parents('tr');
        $.ajax({
            url : "/forms/undo-delete-entry/{{ form._id }}",
            type: "POST",
            dataType: "json",
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify(rowData),
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                }
            },
            success: function(data, textStatus, jqXHR)
            {
                if (data.undone == true) {
                    delete deletedEntries[$row_number]
                    //console.log(deletedEntries);
                    //console.log(rowData);
                    loop=0
                    $row.find('td:not(:first-child)').each (function() {
                        $(this).html(rowData[loop])
                        loop=loop+1;
                    });
                    $row.children(':not(:first-child)').removeClass('deleted-row');
                    $row.children('td').eq(0).html('<i class="fa fa-ban delete-row" aria-hidden="true"></i>');
                }
            }
        });
    });
    $('.delete-row').attr('title', "{%trans%}Delete entry{%endtrans%}");
});
document.getElementById('toggle_notification').addEventListener('click', function(evt){
    $.ajax({
        url : "/form/toggle-notification/{{ form._id }}",
        type: "POST",
        dataType: "json",
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken)
            }
        },
        success: function(data, textStatus, jqXHR)
        {
            if (data.notification == true) {
                $('#notification_true').addClass('btn-success');
                $('#notification_false').removeClass('btn-primary');
            }
            else if (data.notification == false) {
                $('#notification_true').removeClass('btn-success');
                $('#notification_false').addClass('btn-primary');
            }
        }
    });
});
</script>
{% endif %}

{% endblock %}
